services:

  frontend:
    image: nginx
    volumes:
      - ./frontend/dist:/usr/share/nginx/html:ro
      - ./settings/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - 80:80

  couchdb:
    image: couchdb:3
    ports:
      - 5984:5984
    environment:
      - COUCHDB_USER
      - COUCHDB_PASSWORD
    healthcheck:
      test: curl -f http://localhost:5984/_up || exit 1
      start_period: 10s
      start_interval: 2s

  setup_couchdb:
    image: curlimages/curl
    entrypoint: ["/bin/sh","-c"]
    volumes:
      - ./frontend/public/data/sample_data.json:/sample_data.json
    command:
      - |
        alias put="curl -X PUT -u '${COUCHDB_USER}:${COUCHDB_PASSWORD}'"
        put couchdb:5984/_node/nonode@nohost/_config/chttpd/enable_cors --data '"true"'
        put couchdb:5984/_node/nonode@nohost/_config/cors/origins --data '"*"'
        put couchdb:5984/greentube
        put couchdb:5984/greentube/_security --data '{"members":{"roles":[]},"admins":{"roles":["_admin"]}}'
        curl -X POST http://couchdb:5984/greentube/_bulk_docs -H "Content-Type: application/json" -d @/sample_data.json
    depends_on:
      couchdb:
        condition: service_healthy

  index:
    image: curlimages/curl
    entrypoint: ["/bin/sh","-c"]
    volumes:
      - ./backend/src/db/indexes/:/indexes
    command:
      - |
        curl -X POST http://couchdb:5984/greentube/_index -H "Content-Type: application/json" -d @/indexes/videos/by_name.json -u '${COUCHDB_USER}:${COUCHDB_PASSWORD}'
        curl -X POST http://couchdb:5984/greentube/_index -H "Content-Type: application/json" -d @/indexes/videos/by_date.json -u '${COUCHDB_USER}:${COUCHDB_PASSWORD}'
        curl -X POST http://couchdb:5984/greentube/_index -H "Content-Type: application/json" -d @/indexes/videos/by_views.json -u '${COUCHDB_USER}:${COUCHDB_PASSWORD}'
        curl -X POST http://couchdb:5984/greentube/_index -H "Content-Type: application/json" -d @/indexes/users/by_date.json -u '${COUCHDB_USER}:${COUCHDB_PASSWORD}'
        curl -X POST http://couchdb:5984/greentube/_index -H "Content-Type: application/json" -d @/indexes/users/by_name.json -u '${COUCHDB_USER}:${COUCHDB_PASSWORD}'
        curl -X POST http://couchdb:5984/greentube/_index -H "Content-Type: application/json" -d @/indexes/users/by_subs.json -u '${COUCHDB_USER}:${COUCHDB_PASSWORD}'
    depends_on:
      setup_couchdb:
        condition: service_completed_successfully

  backend:
    image: node:20
    working_dir: /app
    volumes:
      - ./backend:/app
    ports:
      - 3000:3000
    environment:
    - CHOKIDAR_USEPOLLING=true
    command: npm run dev
    depends_on:
      - couchdb
